{"version":3,"sources":["../../../src/exact/server/index.ts","../../../src/constants.ts","../../../src/exact/server/scheme.ts","../../../src/exact/server/register.ts"],"sourcesContent":["export { ExactTronScheme } from \"./scheme\";\nexport { registerExactTronServerScheme } from \"./register\";\nexport type { TronServerConfig } from \"./register\";\n","/**\n * @module @erudite-intelligence/x402-tron-v2 - Constants\n * @description Tron network constants for x402 V2 plugin\n * @author Erudite Intelligence LLC (Vector)\n * @created 2026-02-13\n * @purpose Define CAIP-2 identifiers, asset addresses, and network configuration for Tron\n */\n\n// =============================================================================\n// CAIP-2 Network Identifiers\n// Format: tron:<genesis_block_hash_prefix>\n// Reference: https://docs.offblocks.xyz/developer-guides/api-integration/blockchain-identifiers\n// =============================================================================\n\n/** Tron Mainnet CAIP-2 identifier */\nexport const TRON_MAINNET = \"tron:27Lqcw\" as const;\n\n/** Tron Shasta Testnet CAIP-2 identifier */\nexport const TRON_SHASTA = \"tron:4oPwXB\" as const;\n\n/** Tron Nile Testnet CAIP-2 identifier */\nexport const TRON_NILE = \"tron:6FhfKq\" as const;\n\n/** CAIP-2 family pattern for Tron networks */\nexport const TRON_CAIP_FAMILY = \"tron:*\" as const;\n\n/** All supported Tron networks for V2 registration */\nexport const TRON_NETWORKS = [TRON_MAINNET, TRON_SHASTA, TRON_NILE] as const;\n\n/** All supported Tron networks for V1 backwards compatibility */\nexport const TRON_V1_NETWORKS = [TRON_MAINNET] as const;\n\n// =============================================================================\n// RPC Endpoints\n// =============================================================================\n\n/** Default RPC endpoints per CAIP-2 network identifier */\nexport const TRON_RPC_URLS: Record<string, string> = {\n  [TRON_MAINNET]: \"https://api.trongrid.io\",\n  [TRON_SHASTA]: \"https://api.shasta.trongrid.io\",\n  [TRON_NILE]: \"https://nile.trongrid.io\",\n};\n\n// =============================================================================\n// Token Addresses (Base58)\n// =============================================================================\n\n/** USDT TRC-20 contract addresses by CAIP-2 network */\nexport const USDT_ADDRESSES: Record<string, string> = {\n  [TRON_MAINNET]: \"TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t\",\n  [TRON_SHASTA]: \"TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs\", // Shasta USDT\n  [TRON_NILE]: \"TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj\",   // Nile USDT\n};\n\n/** USDC TRC-20 contract addresses by CAIP-2 network */\nexport const USDC_ADDRESSES: Record<string, string> = {\n  [TRON_MAINNET]: \"TEkxiTehnzSmSe2XqrBj4w32RUN966rdz8\",\n};\n\n/** USDT decimals (6) - same across all TRC-20 USDT deployments */\nexport const USDT_DECIMALS = 6;\n\n/** USDC decimals (6) */\nexport const USDC_DECIMALS = 6;\n\n// =============================================================================\n// EruditePay Wrapper Contract\n// The hands-free x402 wrapper contract deployed on Tron mainnet.\n// Collects 0.25% facilitator fee automatically on-chain.\n// =============================================================================\n\n/** EruditePay wrapper contract address on Tron mainnet */\nexport const ERUDITEPAY_WRAPPER_CONTRACT = \"THGkLBrLY1G5VovZjjK1jP9upyxRdMNL3b\";\n\n/** EruditePay facilitator fee: 0.25% (25 basis points) */\nexport const ERUDITEPAY_FEE_BPS = 25;\n\n// =============================================================================\n// TRC-20 ABI (minimal for transfer operations)\n// =============================================================================\n\n/** Minimal TRC-20 ABI for transfer and balance operations */\nexport const TRC20_ABI = [\n  {\n    constant: false,\n    inputs: [\n      { name: \"_to\", type: \"address\" },\n      { name: \"_value\", type: \"uint256\" },\n    ],\n    name: \"transfer\",\n    outputs: [{ name: \"\", type: \"bool\" }],\n    type: \"Function\",\n  },\n  {\n    constant: true,\n    inputs: [{ name: \"_owner\", type: \"address\" }],\n    name: \"balanceOf\",\n    outputs: [{ name: \"balance\", type: \"uint256\" }],\n    type: \"Function\",\n  },\n  {\n    constant: true,\n    inputs: [\n      { name: \"_owner\", type: \"address\" },\n      { name: \"_spender\", type: \"address\" },\n    ],\n    name: \"allowance\",\n    outputs: [{ name: \"remaining\", type: \"uint256\" }],\n    type: \"Function\",\n  },\n  {\n    constant: false,\n    inputs: [\n      { name: \"_spender\", type: \"address\" },\n      { name: \"_value\", type: \"uint256\" },\n    ],\n    name: \"approve\",\n    outputs: [{ name: \"\", type: \"bool\" }],\n    type: \"Function\",\n  },\n  {\n    constant: true,\n    inputs: [],\n    name: \"decimals\",\n    outputs: [{ name: \"\", type: \"uint8\" }],\n    type: \"Function\",\n  },\n] as const;\n\n// =============================================================================\n// Energy/Bandwidth Defaults\n// =============================================================================\n\n/**\n * Estimated energy cost for a TRC-20 transfer.\n * Used for pre-flight checks. Actual cost may vary.\n */\nexport const ESTIMATED_TRC20_TRANSFER_ENERGY = 65_000;\n\n/**\n * Estimated bandwidth cost for a TRC-20 transfer (in bytes).\n * Used for pre-flight checks.\n */\nexport const ESTIMATED_TRC20_TRANSFER_BANDWIDTH = 350;\n\n/**\n * Maximum acceptable energy fee for a facilitator-paid transaction (in SUN).\n * 100 TRX = 100_000_000 SUN. Prevents runaway costs.\n */\nexport const MAX_ENERGY_FEE_SUN = 100_000_000;\n","/**\n * @module @erudite-intelligence/x402-tron-v2 - Server Scheme\n * @description x402 V2 server implementation for Tron. Handles price parsing\n *   and payment requirements enhancement for resource servers (merchants).\n * @author Erudite Intelligence LLC (Vector)\n * @created 2026-02-13\n * @purpose Enable resource servers to set prices in USDT and build Tron payment requirements\n *\n * CHANGELOG:\n * - 2026-02-13: Initial implementation. USDT default asset, custom money parser support.\n */\n\nimport type {\n  AssetAmount,\n  Network,\n  PaymentRequirements,\n  Price,\n  SchemeNetworkServer,\n  MoneyParser,\n} from \"@x402/core/types\";\nimport { USDT_ADDRESSES, USDT_DECIMALS } from \"../../constants\";\n\n/**\n * Tron server implementation for the Exact payment scheme.\n *\n * Converts user-friendly prices (e.g., \"$1.50\", 0.10) into the correct\n * token amount and asset format for Tron TRC-20 tokens.\n *\n * Default behavior:\n * - Treats numeric/string prices as USD amounts\n * - Converts to USDT TRC-20 with 6 decimal precision\n * - e.g., \"$1.50\" → { amount: \"1500000\", asset: \"TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t\" }\n */\nexport class ExactTronScheme implements SchemeNetworkServer {\n  readonly scheme = \"exact\";\n  private moneyParsers: MoneyParser[] = [];\n\n  /**\n   * Register a custom money parser in the parser chain.\n   * Multiple parsers can be registered - they are tried in registration order.\n   * If a parser returns null, the next parser is tried.\n   * The default USDT parser is always the final fallback.\n   *\n   * @param parser - Custom function to convert amount to AssetAmount (or null to skip)\n   * @returns The service instance for chaining\n   */\n  registerMoneyParser(parser: MoneyParser): ExactTronScheme {\n    this.moneyParsers.push(parser);\n    return this;\n  }\n\n  /**\n   * Parses a price into an asset amount for Tron.\n   *\n   * Supports three input formats:\n   * 1. AssetAmount: { amount: \"1000000\", asset: \"TR7NHqje...\" } → pass through\n   * 2. String: \"$1.50\" or \"1.50\" → convert to USDT smallest unit\n   * 3. Number: 1.50 → convert to USDT smallest unit\n   *\n   * @param price - The price to parse\n   * @param network - The Tron network CAIP-2 identifier\n   * @returns Promise resolving to the parsed asset amount\n   */\n  async parsePrice(price: Price, network: Network): Promise<AssetAmount> {\n    // If already an AssetAmount, return it directly\n    if (typeof price === \"object\" && price !== null && \"amount\" in price) {\n      if (!price.asset) {\n        throw new Error(`Asset address must be specified for AssetAmount on network ${network}`);\n      }\n      return {\n        amount: price.amount,\n        asset: price.asset,\n        extra: price.extra || {},\n      };\n    }\n\n    // Parse Money to decimal number\n    const amount = this.parseMoneyToDecimal(price);\n\n    // Try each custom money parser in order\n    for (const parser of this.moneyParsers) {\n      const result = await parser(amount, network);\n      if (result !== null) {\n        return result;\n      }\n    }\n\n    // Default: convert to USDT\n    return this.defaultMoneyConversion(amount, network);\n  }\n\n  /**\n   * Build payment requirements for this scheme/network combination.\n   *\n   * For Tron, this adds Tron-specific metadata to the requirements:\n   * - energyDelegation info from facilitator extra data\n   * - wrapper contract address if applicable\n   *\n   * @param paymentRequirements - Base payment requirements with amount/asset set\n   * @param supportedKind - The supported kind from facilitator's /supported endpoint\n   * @param extensionKeys - Extensions supported by the facilitator\n   * @returns Enhanced payment requirements\n   */\n  enhancePaymentRequirements(\n    paymentRequirements: PaymentRequirements,\n    supportedKind: {\n      x402Version: number;\n      scheme: string;\n      network: Network;\n      extra?: Record<string, unknown>;\n    },\n    extensionKeys: string[],\n  ): Promise<PaymentRequirements> {\n    void extensionKeys;\n\n    const extraData: Record<string, unknown> = {\n      ...paymentRequirements.extra,\n    };\n\n    // Pass through any facilitator-provided extra metadata\n    // Currently no Tron-specific extras are implemented.\n    // When useWrapperContract and feeDelegation go live, their\n    // metadata will be forwarded here.\n    if (supportedKind.extra) {\n      for (const [key, val] of Object.entries(supportedKind.extra)) {\n        if (val !== undefined) {\n          extraData[key] = val;\n        }\n      }\n    }\n\n    return Promise.resolve({\n      ...paymentRequirements,\n      extra: extraData,\n    });\n  }\n\n  /**\n   * Parse Money (string | number) to a decimal number.\n   * Handles formats like \"$1.50\", \"1.50\", 1.50, etc.\n   */\n  private parseMoneyToDecimal(money: string | number): number {\n    if (typeof money === \"number\") {\n      return money;\n    }\n    const cleanMoney = money.replace(/^\\$/, \"\").trim();\n    const amount = parseFloat(cleanMoney);\n    if (isNaN(amount)) {\n      throw new Error(`Invalid money format: ${money}`);\n    }\n    return amount;\n  }\n\n  /**\n   * Default money conversion: USD amount → USDT TRC-20 smallest unit.\n   * USDT has 6 decimals, so $1.50 → 1500000.\n   */\n  private defaultMoneyConversion(amount: number, network: Network): AssetAmount {\n    const usdtAddress = USDT_ADDRESSES[network];\n    if (!usdtAddress) {\n      throw new Error(\n        `No default USDT address configured for network ${network}. ` +\n        `Provide an explicit AssetAmount or register a custom MoneyParser.`,\n      );\n    }\n\n    // Convert decimal amount to smallest unit (6 decimals for USDT)\n    const tokenAmount = Math.round(amount * 10 ** USDT_DECIMALS).toString();\n\n    return {\n      amount: tokenAmount,\n      asset: usdtAddress,\n      extra: {},\n    };\n  }\n}\n","/**\n * @module @erudite-intelligence/x402-tron-v2 - Server Registration\n * @author Erudite Intelligence LLC (Vector)\n * @created 2026-02-13\n */\n\nimport { x402ResourceServer } from \"@x402/core/server\";\nimport type { Network } from \"@x402/core/types\";\nimport { ExactTronScheme } from \"./scheme\";\nimport { TRON_NETWORKS } from \"../../constants\";\n\n/**\n * Configuration options for registering Tron schemes to an x402ResourceServer\n */\nexport interface TronServerConfig {\n  networks?: Network | Network[];\n}\n\n/**\n * Registers Tron exact payment schemes to an x402ResourceServer instance.\n *\n * @param server - The x402ResourceServer instance to register schemes to\n * @param config - Optional configuration for Tron server registration\n * @returns The server instance for chaining\n */\nexport function registerExactTronServerScheme(\n  server: x402ResourceServer,\n  config?: TronServerConfig,\n): x402ResourceServer {\n  const networks = config?.networks\n    ? (Array.isArray(config.networks) ? config.networks : [config.networks])\n    : ([...TRON_NETWORKS] as Network[]);\n\n  const scheme = new ExactTronScheme();\n\n  // x402ResourceServer.register() takes a single Network per call\n  for (const network of networks) {\n    server.register(network, scheme);\n  }\n\n  return server;\n}\n"],"mappings":"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","names":[]}